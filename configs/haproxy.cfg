#---------------------------------------------------------------------
# HAProxy Configuration - Node 1 (MASTER) - HAP-e1 (10.50.50.10)
# Updated: January 18, 2026
# Fixed health checks for SSL backends
#---------------------------------------------------------------------

#---------------------------------------------------------------------
# Global Settings
#---------------------------------------------------------------------
global
    log         /dev/log local0
    log         /dev/log local1 notice
    chroot      /var/lib/haproxy
    stats socket /run/haproxy/admin.sock mode 660 level admin
    stats timeout 30s
    user        haproxy
    group       haproxy
    daemon

    # SSL/TLS Settings
    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-server-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    ssl-default-server-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256
    ssl-default-server-options ssl-min-ver TLSv1.2 no-tls-tickets
    
    ssl-dh-param-file /etc/haproxy/dhparam.pem
    tune.ssl.default-dh-param 2048

    maxconn     50000

#---------------------------------------------------------------------
# Defaults
#---------------------------------------------------------------------
defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    option  http-server-close
    option  forwardfor except 127.0.0.0/8
    option  redispatch
    retries 3
    timeout connect 20s
    timeout client  30s
    timeout server  45s
    timeout http-request 10s
    timeout queue 10s
    timeout check 5s

#---------------------------------------------------------------------
# Stats Page
#---------------------------------------------------------------------
listen stats
    bind *:8404
    bind 10.50.50.100:8404
    stats enable
    stats uri /stats
    stats refresh 30s
    stats auth admin:YourSecurePassword123
    stats admin if TRUE

#---------------------------------------------------------------------
# Frontend - HTTP (Port 80)
#---------------------------------------------------------------------
frontend insecure_connect
    bind 10.50.50.100:80
    mode http
    
    acl http_etherly hdr(host) -i etherly.net
    acl http_tth_gaming hdr(host) -i -m reg (.*\.)?tth-gaming\.de
    acl http_tth_projects hdr(host) -i -m reg (.*\.)?tth-projects\.de
    
    use_backend backend_etherly_http if http_etherly
    use_backend backend_tth_http if http_tth_gaming
    use_backend backend_tth_http if http_tth_projects
    
    redirect scheme https code 301 if !http_etherly

#---------------------------------------------------------------------
# Frontend - HTTPS (Port 443)
#---------------------------------------------------------------------
frontend secure_connect
    bind 10.50.50.100:443 ssl crt /etc/haproxy/certs/cloudflare/c4g7.pem crt /etc/haproxy/certs/letsencrypt/ alpn h2,http/1.1
    mode http
    
    http-response set-header Strict-Transport-Security "max-age=21600000; includeSubDomains"
    http-response set-header X-Frame-Options "SAMEORIGIN"
    http-response set-header X-Content-Type-Options "nosniff"
    
    http-request set-header X-Forwarded-Proto https
    http-request set-header X-Forwarded-Port 443
    
    # ACLs for c4g7.com domain
    acl host_bio hdr(host) -i bio.c4g7.com
    acl host_linkpage hdr(host) -i c4g7.com
    acl host_cloud hdr(host) -i cloud.c4g7.com
    acl host_dns hdr(host) -i dns.c4g7.com
    acl host_floppy hdr(host) -i floppy.c4g7.com
    acl host_host hdr(host) -i host.c4g7.com
    acl host_img hdr(host) -i img.c4g7.com
    acl host_kvm2 hdr(host) -i kvm2.c4g7.com
    acl host_store hdr(host) -i store.c4g7.com
    acl host_vault hdr(host) -i vault.c4g7.com
    acl host_view hdr(host) -i view.c4g7.com
    acl host_vps hdr(host) -i vps.c4g7.com
    acl host_wurzel hdr(host) -i www.wurzelkompass.de
    acl host_rmm hdr(host) -i rmm.c4g7.com
    acl host_api hdr(host) -i api.c4g7.com
    acl host_mesh hdr(host) -i mesh.c4g7.com
    acl host_eager hdr(host) -i eager.c4g7.com
    acl host_staging hdr(host) -i staging.c4g7.com
    acl host_docs hdr(host) -i docs.c4g7.com
    acl host_diary hdr(host) -i diary.c4g7.com
    
    # ACLs for tth domains
    acl host_tth_gaming hdr(host) -i -m reg (.*\.)?tth-gaming\.de
    acl host_tth_projects hdr(host) -i -m reg (.*\.)?tth-projects\.de
    
    # Routing Rules
    use_backend backend_bio if host_bio
    use_backend backend_linkpage if host_linkpage
    use_backend backend_cloud if host_cloud
    use_backend backend_dns if host_dns
    use_backend backend_floppy if host_floppy
    use_backend backend_host if host_host
    use_backend backend_img if host_img
    use_backend backend_kvm2 if host_kvm2
    use_backend backend_store if host_store
    use_backend backend_vault if host_vault
    use_backend backend_view if host_view
    use_backend backend_vps if host_vps
    use_backend backend_wurzel if host_wurzel
    use_backend backend_rmm if host_rmm
    use_backend backend_api if host_api
    use_backend backend_mesh if host_mesh
    use_backend backend_eager if host_eager
    use_backend backend_staging if host_staging
    use_backend backend_docs if host_docs
    use_backend backend_diary if host_diary
    
    use_backend backend_tth_direct if host_tth_gaming
    use_backend backend_tth_direct if host_tth_projects
    
    default_backend backend_default

#=====================================================================
# Backend Definitions - HTTP backends (no SSL to backend)
#=====================================================================

backend backend_bio
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server bio1 10.27.27.10:3000 check

backend backend_cloud
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server cloud1 10.27.27.233:5244 check

backend backend_dns
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server dns1 10.27.27.69:9191 check

backend backend_floppy
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server floppy1 10.27.27.209:3000 check

backend backend_img
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server img1 10.27.27.233:2283 check

backend backend_vault
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server vault1 10.27.27.62:8000 check

backend backend_view
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server view1 10.27.27.213:8000 check inter 5000 fall 3 rise 2

backend backend_wurzel
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server wurzel1 10.27.27.15:3000 check

backend backend_eager
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server eager1 10.27.27.147:20010 check inter 5000 fall 3 rise 2

backend backend_staging
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-599
    server staging1 10.27.27.57:80 check

backend backend_docs
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server docs1 10.27.27.57:3002 check

backend backend_diary
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server diary1 10.27.27.67:5230 check

backend backend_etherly_http
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server etherly1 10.27.27.88:13000 check

backend backend_tth_http
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server tth-http1 10.27.27.248:80 check

#=====================================================================
# Backend Definitions - HTTPS backends (SSL to backend)
# FIXED: Removed option ssl-hello-chk, using check-ssl properly
#=====================================================================

backend backend_linkpage
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server linkpage1 10.27.27.67:2282 check ssl verify none check-ssl

backend backend_host
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server host1 10.27.27.49:443 check ssl verify none check-ssl

backend backend_kvm2
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server kvm2-1 10.27.27.224:8006 check ssl verify none check-ssl

backend backend_store
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server store1 10.27.27.49:443 check ssl verify none check-ssl

backend backend_vps
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-599
    # VPS server has TLS issues - using ssl-min-ver TLSv1.0 for compatibility
        server vps1 10.27.27.16:443 ssl verify none sni str(vps.c4g7.com) check check-sni vps.c4g7.com

backend backend_rmm
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server rmm1 10.27.27.43:443 check ssl verify none check-ssl

backend backend_api
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server api1 10.27.27.43:443 check ssl verify none check-ssl

backend backend_mesh
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-399
    server mesh1 10.27.27.43:443 check ssl verify none check-ssl

backend backend_tth_direct
    mode http
    balance roundrobin
    option httpchk GET /
    http-check expect status 200-599
        server tth1 10.27.27.248:443 ssl verify none sni req.hdr(host) check check-sni tth-gaming.de

#=====================================================================
# Default Backend
#=====================================================================

backend backend_default
    mode http
    http-request deny deny_status 403
# Auto-sync test - Sun Jan 18 14:58:29 UTC 2026
